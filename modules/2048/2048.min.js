define(["require","exports","application"],function(t,i,e){"use strict";var n=angular.module("twentyfourtyeightApp",["Game","ngAnimate","ngCookies"]);angular.extend(i,{name:n.name,module:function(i){t([e.$$cacheUrl("style!modules/2048/2048.css")],function(){i(n)})}}),n.config(["GridServiceProvider",function(i){i.setSize(4)}]).controller("GameController",["GameManager","KeyboardService","$scope","$location",function(i,t,e,n){this.game=i,t.init();var r=this;t.on(function(i){r.game.move(i),e.$digest()}),this.newGame=function(){this.game.newGame()},this.newGame()}]).run(["$templateCache",function(i){i.put("scripts/grid/grid.html",'<div id="game-{{ ngModel.gameSize }}">\n  <div class="grid-container">\n    <div class="grid-cell" ng-repeat="cell in ngModel.grid track by $index"></div>\n  </div>\n\n  <div class="tile-container">\n    <div tile \n          ng-model=\'tile\'\n          ng-repeat=\'tile in ngModel.tiles track by $id(tile.id || $index)\'></div>\n  </div>\n</div>'),i.put("scripts/grid/tile.html","<div ng-if='ngModel' class=\"tile position-{{ ngModel.x }}-{{ ngModel.y }} tile-{{ ngModel.value }} {{ngModel.merged?'tile-merged':''}}\" >\n  <div class=\"tile-inner\">\n    {{ ngModel.value }}\n  </div>\n</div>\n")}]),angular.module("Game",["Grid","Keyboard","ngCookies"]).service("GameManager",["$q","$timeout","GridService","$cookieStore",function(i,t,d,e){this.getHighScore=function(){return parseInt(e.get("highScore"))||0},this.grid=d.grid,this.tiles=d.tiles,this.gameSize=d.getSize(),this.winningValue=2048,this.reinit=function(){this.gameOver=!1,this.win=!1,this.currentScore=0,this.highScore=this.getHighScore()},this.reinit(),this.newGame=function(){d.buildEmptyGameBoard(),d.buildStartingPosition(),this.reinit()},this.move=function(u){var c=this;return i.when(function(){if(c.win)return!1;var i=d.traversalDirections(u),a=!1,h=!1;d.prepareTiles(),i.x.forEach(function(l){i.y.forEach(function(i){var t={x:l,y:i},e=d.getCellAt(t);if(e){var n=d.calculateNextPosition(e,u),r=n.next;if(r&&r.value===e.value&&!r.merged){var o=2*e.value,s=d.newTile(e,o);s.merged=[e,n.next],d.insertTile(s),d.removeTile(e),d.moveTile(s,r),c.updateScore(c.currentScore+n.next.value),s.value>=c.winningValue&&(h=!0),a=!0}else d.moveTile(e,n.newPosition);d.samePositions(t,n.newPosition)||(a=!0)}})}),h&&!c.win&&(c.win=!0),a&&(d.randomlyInsertNewTile(),!c.win&&c.movesAvailable()||(c.gameOver=!0))}())},this.movesAvailable=function(){return d.anyCellsAvailable()||d.tileMatchesAvailable()},this.updateScore=function(i){this.currentScore=i,this.currentScore>this.getHighScore()&&(this.highScore=i,e.put("highScore",i))}}]),angular.module("Grid",[]).factory("GenerateUniqueId",function(){return{next:function(){return e=(new Date).getTime(),"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(i){var t=(e+16*Math.random())%16|0;return e=Math.floor(e/16),("x"===i?t:7&t|8).toString(16)});var e}}}).factory("TileModel",["GenerateUniqueId",function(e){var i=function(i,t){this.x=i.x,this.y=i.y,this.value=t||2,this.id=e.next(),this.merged=null};return i.prototype.savePosition=function(){this.originalX=this.x,this.originalY=this.y},i.prototype.reset=function(){this.merged=null},i.prototype.setMergedBy=function(i){var t=this;i.forEach(function(i){i.merged=!0,i.updatePosition(t.getPosition())})},i.prototype.updateValue=function(i){this.value=i},i.prototype.updatePosition=function(i){this.x=i.x,this.y=i.y},i.prototype.getPosition=function(){return{x:this.x,y:this.y}},i}]).provider("GridService",function(){this.size=4,this.startingTileNumber=2,this.setSize=function(i){this.size=i||0},this.setStartingTiles=function(i){this.startingTileNumber=i};var h=this;this.$get=["TileModel",function(e){this.grid=[],this.tiles=[];var a={left:{x:-1,y:0},right:{x:1,y:0},up:{x:0,y:-1},down:{x:0,y:1}};return this.getSize=function(){return h.size},this.buildEmptyGameBoard=function(){for(var e=this,i=0;i<h.size*h.size;i++)this.grid[i]=null;this.forEach(function(i,t){e.setCellAt({x:i,y:t},null)})},this.prepareTiles=function(){this.forEach(function(i,t,e){e&&(e.savePosition(),e.reset())})},this.traversalDirections=function(i){for(var t=a[i],e={x:[],y:[]},n=0;n<this.size;n++)e.x.push(n),e.y.push(n);return 0<t.x&&(e.x=e.x.reverse()),0<t.y&&(e.y=e.y.reverse()),e},this.calculateNextPosition=function(i,t){for(var e,n=a[t];i={x:(e=i).x+n.x,y:e.y+n.y},this.withinGrid(i)&&this.cellAvailable(i););return{newPosition:e,next:this.getCellAt(i)}},this.withinGrid=function(i){return 0<=i.x&&i.x<this.size&&0<=i.y&&i.y<this.size},this.cellAvailable=function(i){return this.withinGrid(i)?!this.getCellAt(i):null},this.buildStartingPosition=function(){for(var i=0;i<this.startingTileNumber;i++)this.randomlyInsertNewTile()},this.tileMatchesAvailable=function(){for(var i=h.size*h.size,t=0;t<i;t++){var e=this._positionToCoordinates(t),n=this.tiles[t];if(n)for(var r in a){var o=a[r],s={x:e.x+o.x,y:e.y+o.y},l=this.getCellAt(s);if(l&&l.value===n.value)return!0}}return!1},this.getCellAt=function(i){if(this.withinGrid(i)){var t=this._coordinatesToPosition(i);return this.tiles[t]}return null},this.setCellAt=function(i,t){if(this.withinGrid(i)){var e=this._coordinatesToPosition(i);this.tiles[e]=t}},this.moveTile=function(i,t){var e={x:i.x,y:i.y};this.setCellAt(e,null),this.setCellAt(t,i),i.updatePosition(t)},this.forEach=function(i){for(var t=h.size*h.size,e=0;e<t;e++){var n=this._positionToCoordinates(e);i(n.x,n.y,this.tiles[e])}},this._positionToCoordinates=function(i){var t=i%h.size;return{x:t,y:(i-t)/h.size}},this._coordinatesToPosition=function(i){return i.y*h.size+i.x},this.insertTile=function(i){var t=this._coordinatesToPosition(i);this.tiles[t]=i},this.newTile=function(i,t){return new e(i,t)},this.removeTile=function(i){i=this._coordinatesToPosition(i),delete this.tiles[i]},this.samePositions=function(i,t){return i.x===t.x&&i.y===t.y},this.availableCells=function(){var e=[],n=this;return this.forEach(function(i,t){n.getCellAt({x:i,y:t})||e.push({x:i,y:t})}),e},this.randomlyInsertNewTile=function(){var i=this.randomAvailableCell(),t=this.newTile(i,2);this.insertTile(t)},this.randomAvailableCell=function(){var i=this.availableCells();if(0<i.length)return i[Math.floor(Math.random()*i.length)]},this.anyCellsAvailable=function(){return 0<this.availableCells().length},this}]}).directive("grid",function(){return{restrict:"A",require:"ngModel",scope:{ngModel:"="},templateUrl:"scripts/grid/grid.html"}}).directive("tile",function(){return{restrict:"A",scope:{ngModel:"="},templateUrl:"scripts/grid/tile.html"}}),angular.module("Keyboard",[]).service("KeyboardService",["$document",function(i){var n={37:"left",38:"up",39:"right",40:"down"};this.init=function(){var e=this;this.keyEventHandlers=[],i.on("keydown",function(i){var t=n[i.which];t&&(i.preventDefault(),e._handleKeyEvent(t,i))})},this.on=function(i){this.keyEventHandlers.push(i)},this._handleKeyEvent=function(i,t){var e=this.keyEventHandlers;if(e&&(t.preventDefault(),e))for(var n=0;n<e.length;n++){(0,e[n])(i,t)}}}])});