define(["require","exports","application"],function(e,i,t){"use strict";var n=angular.module("2048",["Game","ngAnimate","ngCookies"]);angular.extend(i,{name:n.name,module:function(i){e([t.$$cacheUrl("style!modules/2048/2048.css")],function(){i(n)})}}),n.config(["GridServiceProvider",function(i){i.setSize(4)}]).controller("GameController",["GameManager","KeyboardService","$location","$scope",function(i,e,t,n){this.game=i,e.init(n);var r=this;e.on(function(i){r.game.move(i)}),this.newGame=function(){this.game.newGame()},this.newGame()}]).run(["$templateCache",function(i){i.put("scripts/grid/grid.html",'<div id="game-{{ ngModel.gameSize }}">\n  <div class="grid-container">\n    <div class="grid-cell" ng-repeat="cell in ngModel.grid track by $index"></div>\n  </div>\n\n  <div class="tile-container">\n    <div tile \n          ng-model=\'tile\'\n          ng-repeat=\'tile in ngModel.tiles track by $id(tile.id || $index)\'></div>\n  </div>\n</div>'),i.put("scripts/grid/tile.html","<div ng-if='ngModel' class=\"tile position-{{ ngModel.x }}-{{ ngModel.y }} tile-{{ ngModel.value }} {{ngModel.merged?'tile-merged':''}}\" >\n  <div class=\"tile-inner\">\n    {{ ngModel.value }}\n  </div>\n</div>\n")}]),angular.module("Game",["Grid","Keyboard","ngCookies"]).service("GameManager",["$q","$timeout","GridService","$cookieStore",function(i,e,d,t){this.getHighScore=function(){return parseInt(t.get("highScore"))||0},this.grid=d.grid,this.tiles=d.tiles,this.gameSize=d.getSize(),this.winningValue=2048,this.reinit=function(){this.gameOver=!1,this.win=!1,this.currentScore=0,this.highScore=this.getHighScore()},this.reinit(),this.newGame=function(){d.buildEmptyGameBoard(),d.buildStartingPosition(),this.reinit()},this.move=function(u){var c=this;return i.when(function(){if(c.win)return!1;var i=d.traversalDirections(u),a=!1,h=!1;d.prepareTiles(),i.x.forEach(function(l){i.y.forEach(function(i){var e={x:l,y:i},t=d.getCellAt(e);if(t){var n=d.calculateNextPosition(t,u),r=n.next;if(r&&r.value===t.value&&!r.merged){var o=2*t.value,s=d.newTile(t,o);s.merged=[t,n.next],d.insertTile(s),d.removeTile(t),d.moveTile(s,r),c.updateScore(c.currentScore+n.next.value),s.value>=c.winningValue&&(h=!0),a=!0}else d.moveTile(t,n.newPosition);d.samePositions(e,n.newPosition)||(a=!0)}})}),h&&!c.win&&(c.win=!0),a&&(d.randomlyInsertNewTile(),!c.win&&c.movesAvailable()||(c.gameOver=!0))}())},this.movesAvailable=function(){return d.anyCellsAvailable()||d.tileMatchesAvailable()},this.updateScore=function(i){this.currentScore=i,this.currentScore>this.getHighScore()&&(this.highScore=i,t.put("highScore",i))}}]),angular.module("Grid",[]).factory("GenerateUniqueId",function(){return{next:function(){return t=(new Date).getTime(),"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(i){var e=(t+16*Math.random())%16|0;return t=Math.floor(t/16),("x"===i?e:7&e|8).toString(16)});var t}}}).factory("TileModel",["GenerateUniqueId",function(t){var i=function(i,e){this.x=i.x,this.y=i.y,this.value=e||2,this.id=t.next(),this.merged=null};return i.prototype.savePosition=function(){this.originalX=this.x,this.originalY=this.y},i.prototype.reset=function(){this.merged=null},i.prototype.setMergedBy=function(i){var e=this;i.forEach(function(i){i.merged=!0,i.updatePosition(e.getPosition())})},i.prototype.updateValue=function(i){this.value=i},i.prototype.updatePosition=function(i){this.x=i.x,this.y=i.y},i.prototype.getPosition=function(){return{x:this.x,y:this.y}},i}]).provider("GridService",function(){this.size=4,this.startingTileNumber=2,this.setSize=function(i){this.size=i||0},this.setStartingTiles=function(i){this.startingTileNumber=i};var h=this;this.$get=["TileModel",function(t){this.grid=[],this.tiles=[];var a={left:{x:-1,y:0},right:{x:1,y:0},up:{x:0,y:-1},down:{x:0,y:1}};return this.getSize=function(){return h.size},this.buildEmptyGameBoard=function(){for(var t=this,i=0;i<h.size*h.size;i++)this.grid[i]=null;this.forEach(function(i,e){t.setCellAt({x:i,y:e},null)})},this.prepareTiles=function(){this.forEach(function(i,e,t){t&&(t.savePosition(),t.reset())})},this.traversalDirections=function(i){for(var e=a[i],t={x:[],y:[]},n=0;n<this.size;n++)t.x.push(n),t.y.push(n);return 0<e.x&&(t.x=t.x.reverse()),0<e.y&&(t.y=t.y.reverse()),t},this.calculateNextPosition=function(i,e){for(var t,n=a[e];i={x:(t=i).x+n.x,y:t.y+n.y},this.withinGrid(i)&&this.cellAvailable(i););return{newPosition:t,next:this.getCellAt(i)}},this.withinGrid=function(i){return 0<=i.x&&i.x<this.size&&0<=i.y&&i.y<this.size},this.cellAvailable=function(i){return this.withinGrid(i)?!this.getCellAt(i):null},this.buildStartingPosition=function(){for(var i=0;i<this.startingTileNumber;i++)this.randomlyInsertNewTile()},this.tileMatchesAvailable=function(){for(var i=h.size*h.size,e=0;e<i;e++){var t=this._positionToCoordinates(e),n=this.tiles[e];if(n)for(var r in a){var o=a[r],s={x:t.x+o.x,y:t.y+o.y},l=this.getCellAt(s);if(l&&l.value===n.value)return!0}}return!1},this.getCellAt=function(i){if(this.withinGrid(i)){var e=this._coordinatesToPosition(i);return this.tiles[e]}return null},this.setCellAt=function(i,e){if(this.withinGrid(i)){var t=this._coordinatesToPosition(i);this.tiles[t]=e}},this.moveTile=function(i,e){var t={x:i.x,y:i.y};this.setCellAt(t,null),this.setCellAt(e,i),i.updatePosition(e)},this.forEach=function(i){for(var e=h.size*h.size,t=0;t<e;t++){var n=this._positionToCoordinates(t);i(n.x,n.y,this.tiles[t])}},this._positionToCoordinates=function(i){var e=i%h.size;return{x:e,y:(i-e)/h.size}},this._coordinatesToPosition=function(i){return i.y*h.size+i.x},this.insertTile=function(i){var e=this._coordinatesToPosition(i);this.tiles[e]=i},this.newTile=function(i,e){return new t(i,e)},this.removeTile=function(i){i=this._coordinatesToPosition(i),delete this.tiles[i]},this.samePositions=function(i,e){return i.x===e.x&&i.y===e.y},this.availableCells=function(){var t=[],n=this;return this.forEach(function(i,e){n.getCellAt({x:i,y:e})||t.push({x:i,y:e})}),t},this.randomlyInsertNewTile=function(){var i=this.randomAvailableCell(),e=this.newTile(i,2);this.insertTile(e)},this.randomAvailableCell=function(){var i=this.availableCells();if(0<i.length)return i[Math.floor(Math.random()*i.length)]},this.anyCellsAvailable=function(){return 0<this.availableCells().length},this}]}).directive("grid",function(){return{restrict:"A",require:"ngModel",scope:{ngModel:"="},templateUrl:"scripts/grid/grid.html"}}).directive("tile",function(){return{restrict:"A",scope:{ngModel:"="},templateUrl:"scripts/grid/tile.html"}}),angular.module("Keyboard",[]).service("KeyboardService",["$rootElement",function(i){var r={37:"left",38:"up",39:"right",40:"down"};this.init=function(t){var n=this;this.keyEventHandlers=[],i.on("keydown",function(i){var e=r[i.which];e&&(i.preventDefault(),n._handleKeyEvent(e,i),t.$digest())})},this.on=function(i){this.keyEventHandlers.push(i)},this._handleKeyEvent=function(i,e){var t=this.keyEventHandlers;if(t&&(e.preventDefault(),t))for(var n=0;n<t.length;n++){(0,t[n])(i,e)}}}])});