define(["require","exports","application"],function(a,e,n){function l(e){var t=this.locale;o.dynamics=o.dynamics||{$$buf:{},put:function(a){a&&(a=a.substr(0,a.lastIndexOf("/")),this.$$buf[a]=!0)},has:function(a){return a=a.substr(0,a.lastIndexOf("/")),!!this.$$buf[a]}};var r=l.languages=l.languages||{},u=r[t]=r[t]||{},i=n.routes.concat(n.layout).filter(function(a){var e=a.language[t];return e&&!u[e]&&(!a.extras.dynamic||o.dynamics.has(e))}).map(function(a){return a.language[t]}),g="lib/angular.js/i18n/angular-locale_LOCALE.js";i.unshift(g.replace(/LOCALE/,t)),p&&p.$broadcast("$localeChangeStart",t),a(i,function(){for(var a=0;a<i.length;a++){var n=i[a];if(a)u[n]=!0,i[a]=[n,arguments[a]];else{var l=u[n]=u[n]||s(["ngLocale"]).get("$locale");i[a]=[g,arguments[a]],y.$locale&&y.$locale.id!==l.id&&f(y.$locale,l)}}o.bind({locale:t})(i),e&&e(c),p&&p.$broadcast("$localeChangeSuccess",t)})}function o(){var a=$[this.locale]=$[this.locale]||{};i(d.apply(arguments),function(e){i(e,function(e){o.dynamics.put(e[0]),i(e[1],function(e,n){a[n.toLowerCase()]=e})})})}function t(a){if(a=(a||Modernizr.localstorage&&localStorage["system.locale"]||navigator.languages&&navigator.languages[0]||navigator.language||navigator.userLanguage||y.locale||"zh-cn").toLowerCase(),-1==y.locales.indexOf(a)&&(a="zh-cn"),-1!==y.locales.indexOf(a)&&Modernizr.localstorage)try{localStorage["system.locale"]=a}catch(a){}return a}function r(a){if(!a)return"";a=a.trim().toLowerCase();var e=($[y.locale]||{})[a];if(!e)return"TODO: Translate `"+a+"` in `"+y.locale+"`";var n=d.call(arguments,1);return n.length?e.replace(/\{(\d+)\}/g,function(a,e){var l=n[0|e];return void 0!==l?l:a}):e}var c=angular.module("gui.language",["ng"]),u=n.uefi,i=angular.forEach,s=angular.injector,g=angular.extend,f=angular.merge,d=Array.prototype.slice,$={},p=null,y={$locale:null,currency:n.currency||"Â¥",locales:n.locales||["zh-cn"],locale:n.locale};y.locale=t(),g(e,{name:c.name,module:l.bind({locale:y.locale})}),["locale","locales","currency"].forEach(function(a){delete n[a]}),c.config(["$provide",function(a){y.$locale||(u.progress("Application","setup gui.language"),a.decorator("currencyFilter",["$delegate",function(a){return g(function(){var e=d.apply(arguments);return e[1]&&"$system$"!==e[1]||(e[1]=y.currency),a.apply(a,e)},{$stateful:!0})}]),["date","number"].forEach(function(e){a.decorator(e+"Filter",["$delegate",function(a){return g(a,{$stateful:!0})}])}))}]).run(["$locale","$rootScope",function(a,e){y.$locale||(y.$locale=a,angular.extend(p=e,{language:{loadLanguage:o.bind(y),translate:r.bind({}),getLocale:function(){return y.locale},getLocales:function(){return[].concat(y.locales)},setLocale:function(a){a=t(a.toLowerCase()),l.bind({locale:a})(function(){y.locale=a})}}}))}]).filter("translate",function(){return g(r,{$stateful:!0})})});